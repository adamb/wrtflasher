# Template Sensors for Mesh Network Monitor
#
# These create aggregate sensors (totals across all nodes)
#
# Add to configuration.yaml:
#   template:
#     - sensor: !include template_sensors.yaml
#
# Then restart Home Assistant or reload template entities.

# Total clients across all nodes
- name: "Mesh Total Clients"
  unique_id: mesh_total_clients
  state: >
    {{
      states('sensor.mesh_node_gw_office_clients_total')|int(0) +
      states('sensor.mesh_node_ap_ec54_clients_total')|int(0) +
      states('sensor.mesh_node_ap_d74c_clients_total')|int(0) +
      states('sensor.mesh_node_ap_repay_ruffled_clients_total')|int(0) +
      states('sensor.mesh_node_ap_gate_clients_total')|int(0) +
      states('sensor.mesh_node_ap_repay_surrender_clients_total')|int(0) +
      states('sensor.mesh_node_ap_dc99_clients_total')|int(0)
    }}
  unit_of_measurement: "clients"
  icon: mdi:devices

- name: "Mesh Total Clients Finca"
  unique_id: mesh_total_clients_finca
  state: >
    {{
      states('sensor.mesh_node_gw_office_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_ec54_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_d74c_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_repay_ruffled_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_gate_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_repay_surrender_clients_finca')|int(0) +
      states('sensor.mesh_node_ap_dc99_clients_finca')|int(0)
    }}
  unit_of_measurement: "clients"
  icon: mdi:home-wifi

- name: "Mesh Total Clients IoT"
  unique_id: mesh_total_clients_iot
  state: >
    {{
      states('sensor.mesh_node_gw_office_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_ec54_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_d74c_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_repay_ruffled_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_gate_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_repay_surrender_clients_iot')|int(0) +
      states('sensor.mesh_node_ap_dc99_clients_iot')|int(0)
    }}
  unit_of_measurement: "clients"
  icon: mdi:devices

- name: "Mesh Total Clients Guest"
  unique_id: mesh_total_clients_guest
  
  state: >
    {{
      states('sensor.mesh_node_gw_office_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_ec54_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_d74c_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_repay_ruffled_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_gate_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_repay_surrender_clients_guest')|int(0) +
      states('sensor.mesh_node_ap_dc99_clients_guest')|int(0)
    }}
  unit_of_measurement: "clients"
  icon: mdi:account-multiple

# AC Temperature Corrections
#
# Main AC (MQTT/LinknLink): Fixed via temperature_unit: °C in configuration.yaml
#
# Cocina/Cuarito (Tuya): Current temps are correct, but Tuya pre-converts
# setpoints to °F while telling HA they're °C, causing double-conversion.
# These template sensors reverse the double-conversion to show correct °F setpoints.

# Cocina AC: setpoint is °F but HA double-converts it (treats °F as °C → °F)
- name: "Cocina AC Setpoint"
  unique_id: cocina_ac_setpoint
  device_class: temperature
  unit_of_measurement: "°F"
  state: >
    {% set temp = state_attr('climate.casita_kitchen', 'temperature') %}
    {{ ((temp - 32) * 5/9) | round(0) if temp is not none else None }}

# Cuarito AC: same double-conversion issue as Cocina
- name: "Cuarito AC Setpoint"
  unique_id: cuarito_ac_setpoint
  device_class: temperature
  unit_of_measurement: "°F"
  state: >
    {% set temp = state_attr('climate.air_conditioner_2', 'temperature') %}
    {{ ((temp - 32) * 5/9) | round(0) if temp is not none else None }}
