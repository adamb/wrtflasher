- id: power_voltage_alerts_l1_l2_imbalance
  alias: Power - Voltage alerts (L1/L2 + imbalance)
  mode: single

  trigger:
    # Heads-up (sustained)
    - platform: numeric_state
      entity_id: sensor.sense_222077_l1_voltage
      below: 112
      for: "00:05:00"
      id: l1_low_warn
    - platform: numeric_state
      entity_id: sensor.sense_222077_l2_voltage
      below: 112
      for: "00:05:00"
      id: l2_low_warn
    - platform: numeric_state
      entity_id: sensor.sense_222077_l1_voltage
      above: 128
      for: "00:05:00"
      id: l1_high_warn
    - platform: numeric_state
      entity_id: sensor.sense_222077_l2_voltage
      above: 128
      for: "00:05:00"
      id: l2_high_warn

    # Wake-me-up (more urgent)
    - platform: numeric_state
      entity_id: sensor.sense_222077_l1_voltage
      below: 108
      for: "00:01:00"
      id: l1_low_crit
    - platform: numeric_state
      entity_id: sensor.sense_222077_l2_voltage
      below: 108
      for: "00:01:00"
      id: l2_low_crit
    - platform: numeric_state
      entity_id: sensor.sense_222077_l1_voltage
      above: 132
      for: "00:01:00"
      id: l1_high_crit
    - platform: numeric_state
      entity_id: sensor.sense_222077_l2_voltage
      above: 132
      for: "00:01:00"
      id: l2_high_crit

    # Imbalance (loose-neutral signature)
    - platform: template
      value_template: >
        {{ (states('sensor.sense_222077_l1_voltage')|float(0) -
            states('sensor.sense_222077_l2_voltage')|float(0)) | abs > 6 }}
      for: "00:03:00"
      id: imbalance_warn

    - platform: template
      value_template: >
        {{ (states('sensor.sense_222077_l1_voltage')|float(0) -
            states('sensor.sense_222077_l2_voltage')|float(0)) | abs > 10 }}
      for: "00:01:00"
      id: imbalance_crit

  condition:
    # Cooldown: only alert if last trigger was > 30 minutes ago
    - condition: template
      value_template: >
        {% set last = state_attr(this.entity_id, 'last_triggered') %}
        {{ last is none or (as_timestamp(now()) - as_timestamp(last)) > 1800 }}

  action:
    - variables:
        l1: "{{ states('sensor.sense_222077_l1_voltage')|float(0) }}"
        l2: "{{ states('sensor.sense_222077_l2_voltage')|float(0) }}"
        diff: "{{ (l1 - l2) | abs }}"
        trig: "{{ trigger.id }}"

    - choose:
        - conditions: "{{ trig in ['l1_low_crit','l2_low_crit','l1_high_crit','l2_high_crit','imbalance_crit'] }}"
          sequence:
            - service: notify.mobile_app_blue17
              data:
                title: "âš ï¸ Voltage CRITICAL"
                message: >
                  Trigger: {{ trig }}. L1={{ '%.1f'|format(l1) }}V, L2={{ '%.1f'|format(l2) }}V, Î”={{ '%.1f'|format(diff) }}V.
                  (sustained)

        - conditions: "{{ trig in ['l1_low_warn','l2_low_warn','l1_high_warn','l2_high_warn','imbalance_warn'] }}"
          sequence:
            - service: notify.mobile_app_blue17
              data:
                title: "ðŸ”” Voltage warning"
                message: >
                  Trigger: {{ trig }}. L1={{ '%.1f'|format(l1) }}V, L2={{ '%.1f'|format(l2) }}V, Î”={{ '%.1f'|format(diff) }}V.
                  (sustained)
