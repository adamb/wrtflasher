# Network Documentation

## Overview

Three isolated networks using VLANs over a batman-adv mesh:
- **Finca (VLAN 10)**: Trusted devices - 192.168.1.0/24
- **IOT (VLAN 20)**: Untrusted IoT devices - 192.168.3.0/24
- **Guest (VLAN 30)**: WiFi-only, internet access - 192.168.4.0/24

## Hardware

### Gateway: OpenWRT One (gw-office)
- **eth0** (2.5G): LAN trunk to Zyxel switch (VLAN 10,20,30 tagged)
- **eth1** (1G): WAN - Starlink (primary)
- **eth2** (USB): WAN2 - T-Mobile via USB ethernet (failover)
- **IP**: 192.168.1.1

### Access Points: GL-MT3000 (BerylAX)
- Mesh nodes, no routing
- Hostnames auto-generated as `ap-XXXX` from MAC
- eth0/eth1 bridged to br-lan for wired devices

### Switch: Zyxel GS1200-8
- **Management**: 192.168.1.3 (VLAN 10)

| Port | Device | VLAN | Mode |
|------|--------|------|------|
| 1 | Gateway (eth0) | 10,20,30 | Tagged (trunk) |
| 2 | Home Assistant | 10,20 | Tagged |
| 3 | Debian box | 10,20 | Tagged |
| 4 | NAS | 10 | Untagged |
| 5 | Time Capsule | 10 | Untagged |
| 6 | Power cable | 20 | Untagged |
| 7 | Ring Alarm | 20 | Untagged |
| 8 | Spare | 1 | Untagged |

**PVID Settings**: Port 4-5 = 10, Port 6-7 = 20, others = 1

## WiFi Networks

| SSID | VLAN | Network | Encryption | 802.11r | Purpose |
|------|------|---------|------------|---------|---------|
| Finca | 10 | 192.168.1.0/24 | WPA3-SAE-Mixed | Yes | Trusted devices |
| IOT | 20 | 192.168.3.0/24 | WPA2-PSK | No | IoT devices (legacy compat) |
| Guest | 30 | 192.168.4.0/24 | WPA3-SAE-Mixed | Yes | Guest access |

**Mesh backhaul**: `batmesh_network` on 5GHz (radio1, channel 36, WPA3-SAE)
**Client WiFi**: 2.4GHz (radio0, channel 6)

**Note**: IOT network uses WPA2-PSK (psk2) instead of WPA3 for compatibility with legacy IoT devices that don't support WPA3. Fast roaming (802.11r) and management frame protection (802.11w) are disabled for maximum compatibility.

## Firewall Rules

### Zone Configuration
- **LAN zone**: Can access WAN and IoT networks
- **IoT zone**: Can only access WAN (internet), isolated from LAN/Guest
- **Guest zone**: Can only access WAN (internet), fully isolated from LAN/IoT

### Forwarding Rules
| Source | Destination | Status | Notes |
|--------|-------------|--------|-------|
| LAN | WAN | ‚úÖ | Internet access |
| LAN | IoT | ‚úÖ | Manage IoT devices (Remootio, Ring cameras, etc.) |
| LAN | Guest | ‚ùå | Guest network isolated |
| IoT | WAN | ‚úÖ | Internet access only |
| IoT | LAN | üîÑ | Replies only (stateful firewall) |
| IoT | Guest | ‚ùå | Fully isolated |
| Guest | WAN | ‚úÖ | Internet access only |
| Guest | LAN | ‚ùå | Fully isolated |
| Guest | IoT | ‚ùå | Fully isolated |

### Special Rules
- **Home Assistant exception**: Device at 192.168.1.50 can access IoT network (configured in config.sh)

### Security Model
The firewall uses **stateful connection tracking**:
- LAN devices can initiate connections to IoT devices
- IoT devices can reply to LAN-initiated connections
- IoT devices **cannot** initiate new connections to LAN
- This prevents compromised IoT devices from attacking trusted LAN devices

### Implementation
Firewall rules are generated by `generate-config.sh` from `config.sh` and applied on first boot. To modify:
1. Edit firewall section in `generate-config.sh`
2. Run `./build.sh` to rebuild firmware
3. Or manually apply with UCI commands and update repo

## Dual-WAN Failover

- **Primary (wan)**: eth1 - Starlink
- **Failover (wan2)**: eth2 - T-Mobile USB ethernet
- **mwan3** handles automatic failover

## Useful Commands

```bash
# Mesh status
batctl meshif bat0 n          # neighbors
batctl meshif bat0 o          # all nodes with link quality

# WiFi clients
iw dev phy0-ap0 station dump | grep -E "Station|signal"

# Network status
ip link | grep br-            # bridges
cat /tmp/dhcp.leases          # DHCP clients

# mwan3
mwan3 status                  # failover status
```

## Mesh Management

Use `mesh-exec.sh` to run commands on all nodes simultaneously:

```bash
# Check all node hostnames
./mesh-exec.sh "cat /proc/sys/kernel/hostname"

# Check mesh neighbors on all nodes
./mesh-exec.sh "batctl meshif bat0 n"

# Check WiFi channel configuration
./mesh-exec.sh "uci show wireless.radio0.channel && uci show wireless.radio1.channel"

# Reload WiFi on all nodes
./mesh-exec.sh "wifi reload"

# Change IOT network to WPA2-PSK for legacy device compatibility
./mesh-exec.sh "uci set wireless.iot0.encryption='psk2'; uci set wireless.iot0.ieee80211r='0'; uci set wireless.iot0.ieee80211w='0'; uci commit wireless; wifi reload"

# Check uptime on all nodes
./mesh-exec.sh "uptime"

# Check batman gateway mode
./mesh-exec.sh "batctl meshif bat0 gw"
```

## IP Reservations

| Device | IP | MAC |
|--------|----|----|
| Gateway | 192.168.1.1 | - |
| Switch | 192.168.1.3 | - |
| APs | 192.168.1.100+ | DHCP |

## Traffic Flow

```
Device ‚Üí SSID/wired port ‚Üí VLAN (10/20/30) ‚Üí switch/mesh ‚Üí Gateway ‚Üí mwan3 ‚Üí Internet
```
